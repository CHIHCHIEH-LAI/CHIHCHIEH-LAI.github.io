<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NBA Players Visualization</title>
    <link rel="stylesheet" href="styles.css"> <!-- Optional: Link your custom CSS styles -->
    <style>
        /* Add any necessary CSS styles for your visualization */

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>

<body>
    <!-- Create a container for your visualization and dropdown menu -->
    <div id="container">
        <div id="visualization-container"></div>
        <div id="dropdown-container">
            <label for="country-select">Select Country:</label>
            <select id="country-select">
                <option value="USA">USA</option>
                <option value="Other">Other</option>
            </select>
        </div>
    </div>

    <!-- Include D3 and other necessary libraries -->
    <script src="https://d3js.org/d3.v6.min.js"></script> <!-- Include D3 library -->
    <script src="https://d3-annotation.susielu.com/d3-annotation.v3.min.js"></script> <!-- Include d3-annotation library -->
    <script src="https://unpkg.com/topojson-client@3"></script> <!-- Include topoJSON Client library -->

    <script>
        // Load the bar chart dataset
        d3.csv("average_salary_by_position.csv").then(function (barChartData) {
            // Preprocess the bar chart data
            barChartData.forEach(function (d) {
                d.average_salary = +d.average_salary;
                d.record_count = +d.record_count;
            });

            // Load the scatter plot dataset
            d3.csv("salary_rating_table.csv").then(function (scatterPlotData) {
                // Preprocess the scatter plot data
                scatterPlotData.forEach(function (d) {
                    d.salary = +d.salary;
                    d.rating = +d.rating;
                });

                // Define the parameters
                var selectedCountry = "USA";
                var selectedPosition = "G";

                // Handle the dropdown menu selection
                d3.select("#container").select("#dropdown-container").select("#country-select").on("change", function () {
                    selectedCountry = this.value;
                    updateVisualization();
                });

                // Function to clear the chart
                function clearChart() {
                  d3.select("#container").select("#visualization-container").selectAll("svg").remove();
                }

                // Function to update the visualization based on the selected country
                function updateVisualization() {
                    // Clear the existing chart
                    clearChart();
                    
                    // Filter the scatter plot data based on the selected country and position
                    var filteredBarChartData = barChartData.filter(function (d) {
                        return d.country === selectedCountry;
                    });
                    
                    // Call the functions to build/update the initial scenes
                    buildOverviewBarChart(filteredBarChartData);
                    // buildOverviewBarChart(barChartData);
                    // buildScatterPlot(filteredScatterPlotData);
                }

                // Build the first scene - Overview bar chart
                function buildOverviewBarChart(data) {
                    // Define the dimensions and margins for the chart
                    var width = 600;
                    var height = 300;
                    var margin = { top: 40, right: 20, bottom: 50, left: 65};

                    // Create the SVG element
                    var svg = d3.select("#container").select("#visualization-container")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    // Define x and y scales
                    var x = d3.scaleBand()
                        .domain(['G', 'G-F', 'F', 'F-C', 'C'])
                        .range([0, width])
                        .padding(0.2);

                    var y = d3.scaleLinear()
                        .domain([0, 18000000])
                        .range([height, 0]);

                    // Define the y-axis generator with customized tick format
                    var yAxis = d3.axisLeft(y)
                        .tickFormat(d3.format("~s")); // Custom format: e.g., "1M" instead of "1000000"

                    // Implement the bar chart using D3
                    var bars = svg.selectAll("rect")
                        .data(data)
                        .enter()
                        .append("rect")
                        .attr("x", function (d) { return x(d.position); })
                        .attr("y", function (d) { return y(d.average_salary); })
                        .attr("width", x.bandwidth())
                        .attr("height", function (d) { return height - y(d.average_salary); })
                        .attr("fill", "steelblue")
                        .on("click", function (d) {
                            // Clear the existing chart
                            clearChart();
                            
                            // Filter the scatter plot data based on the selected bar
                            var filteredScatterPlotData = scatterPlotData.filter(function (scatterData) {
                                return d.country === selectedCountry && d.position === selectedPosition;
                            });
                            
                            // Call the function to build the scatter plot scene
                            buildScatterPlot(filteredScatterPlotData);
                        });

                    // Add axes
                    svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));

                    svg.append("g")
                        .call(yAxis);

                    // Add axis titles
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", height + margin.bottom - 10)
                        .attr("text-anchor", "middle")
                        .text("Position");

                    svg.append("text")
                        .attr("x", -margin.left+20)
                        .attr("y", height / 2)
                        .attr("text-anchor", "middle")
                        .attr("transform", "rotate(-90, " + (-margin.left+20) + ", " + height / 2 + ")")
                        .text("Average Salary ($)");

                    // Add chart title
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", -margin.top+20)
                        .attr("text-anchor", "middle")
                        .style("font-size", "22px")
                        .style("font-weight", "bold")
                        .text("NBA Players Average Salary by Position");

                    //  Add tooltips using d3-annotation
                    bars.append("title")
                        .text(function (d) { 
                            var scaledSalary = (d.average_salary / 1000000).toFixed(3);
                            return "Position: " + d.position + "\nRecord Count: " + d.record_count + "\nAverage Salary: $" + scaledSalary + "M"; 
                        });
                }

                // Build the second scene - Scatter plot
                function buildScatterPlot(data) {
                    // Define the dimensions and margins for the plot
                    var width = 500;
                    var height = 300;
                    var margin = { top: 20, right: 20, bottom: 50, left: 50 };

                    // Create the SVG element
                    var svg = d3.select("#container").select("#visualization-container")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    // Define x and y scales
                    var x = d3.scaleLinear()
                        .domain([0, 46000000])
                        .range([0, width]);
                
                    var y = d3.scaleLinear()
                        .domain([60, 100])
                        .range([height, 0]);

                    var xAxis = d3.axisBottom(x)
                        .tickFormat(d3.format("~s")); // Custom format: e.g., "1M" instead of "1000000"

                    // Create circles for the scatter plot
                    svg.selectAll("circle")
                        .data(data)
                        .enter()
                        .append("circle")
                        .attr("cx", function(d) { return x(d.salary); })
                        .attr("cy", function(d) { return y(d.rating); })
                        .attr("r", 4)
                        .attr("fill", "steelblue");

                    // Add axes
                    svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis);
                
                    svg.append("g")
                        .call(d3.axisLeft(y));

                    // Add axis titles
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", height + margin.bottom - 10)
                        .attr("text-anchor", "middle")
                        .text("Salary");
                
                    svg.append("text")
                        .attr("x", -margin.left + 20)
                        .attr("y", height / 2)
                        .attr("text-anchor", "middle")
                        .attr("transform", "rotate(-90, " + (-margin.left + 20) + ", " + height / 2 + ")")
                        .text("Rating");

                    // Add chart title
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", -margin.top + 20)
                        .attr("text-anchor", "middle")
                        .style("font-size", "22px")
                        .style("font-weight", "bold")
                        .text("NBA Players Salary vs Rating");

                    // Add tooltips using d3-annotation
                    // svg.selectAll("circle")
                    //     .append("title")
                    //     .text(function(d) {
                    //         return "Salary: $" + d.salary.toLocaleString() + "\nRating: " + d.rating;
                    //     });
                }
                
                // Call the function to initially build the visualization
                updateVisualization();
                
            }).catch(function (error) {
                console.log(error);
            });
        }).catch(function (error) {
            console.log(error);
        });
    </script>
</body>
</html>
