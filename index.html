<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NBA Players Visualization</title>
    <link rel="stylesheet" href="styles.css"> <!-- Optional: Link your custom CSS styles -->
    <style>
        /* Add any necessary CSS styles for your visualization */

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .back-button {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px;
            background-color: #ddd;
            border: none;
            cursor: pointer;
    </style>
</head>

<body>
    <!-- Create a container for your visualization and dropdown menu -->
    <div id="container">
        <button class="back-button" onclick="goBack()">Back</button>
        <div id="visualization-container"></div>
        <div id="dropdown-container">
            <label for="country-select">Select Country:</label>
            <select id="country-select">
                <option value="USA">USA</option>
                <option value="Other">Other</option>
            </select>
        </div>
    </div>

    <!-- Include D3 and other necessary libraries -->
    <script src="https://d3js.org/d3.v6.min.js"></script> <!-- Include D3 library -->
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script> <!-- Include d3-annotation library -->
    <script src="https://unpkg.com/topojson-client@3"></script> <!-- Include topoJSON Client library -->

    <script>
        // Load the bar chart dataset
        d3.csv("average_salary_by_position.csv").then(function (barChartData) {
            // Preprocess the bar chart data
            barChartData.forEach(function (d) {
                d.average_salary = +d.average_salary;
                d.record_count = +d.record_count;
            });

            // Load the scatter plot dataset
            d3.csv("salary_rating_table.csv").then(function (scatterPlotData) {
                // Preprocess the scatter plot data
                scatterPlotData.forEach(function (d) {
                    d.salary = +d.salary;
                    d.rating = +d.rating;
                });

                // Define the parameters
                var selectedCountry = "USA";
                var selectedPosition = "G";
                var isSecondScene = false; // Flag to track if the second scene is built

                // Handle the dropdown menu selection
                d3.select("#container").select("#dropdown-container").select("#country-select").on("change", function () {
                    selectedCountry = this.value;
                    updateVisualization();
                });

                // Function to clear the chart
                function clearChart() {
                    d3.select("#container").select("#visualization-container").selectAll("svg").remove();
                }

                // Function to go back to the first scene
                function goBack() {
                    isSecondScene = false;
                    updateVisualization();
                }

                // Function to update the visualization based on the selected country and scene
                function updateVisualization() {
                    // Clear the existing chart
                    clearChart();

                    if (isSecondScene) {
                        // Show the back button
                        d3.select("#container").select("#back-button").style("display", "block");
                        buildScatterPlot();
                    } else {
                        // Hide the back button
                        d3.select("#container").select("#back-button").style("display", "none");
                        buildOverviewBarChart();
                    }
                }

                // Build the first scene - Overview bar chart
                function buildOverviewBarChart() {
                    // Define the dimensions and margins for the chart
                    var width = 600;
                    var height = 300;
                    var margin = { top: 40, right: 20, bottom: 50, left: 65};

                    // Create the SVG element
                    var svg = d3.select("#container").select("#visualization-container")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    // Define x and y scales
                    var x = d3.scaleBand()
                        .domain(['G', 'G-F', 'F', 'F-C', 'C'])
                        .range([0, width])
                        .padding(0.2);

                    var y = d3.scaleLinear()
                        .domain([0, 18000000])
                        .range([height, 0]);

                    // Define the y-axis generator with customized tick format
                    var yAxis = d3.axisLeft(y)
                        .tickFormat(d3.format("~s")); // Custom format: e.g., "1M" instead of "1000000"

                    // Filter the scatter plot data based on the selected country and position (example code)
                    var filteredBarChartData = barChartData.filter(function(d) {
                      return d.country === selectedCountry;
                    });

                    // Implement the bar chart using D3
                    var bars = svg.selectAll("rect")
                        .data(filteredBarChartData)
                        .enter()
                        .append("rect")
                        .attr("x", function (d) { return x(d.position); })
                        .attr("y", function (d) { return y(d.average_salary); })
                        .attr("width", x.bandwidth())
                        .attr("height", function (d) { return height - y(d.average_salary); })
                        .attr("fill", "steelblue")
                        .on("click", function (d) {
                            isSecondScene = true;
                            selectedPosition = d.srcElement.__data__.position;
                            updateVisualization();
                        });

                    // Add axes
                    svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));

                    svg.append("g")
                        .call(yAxis);

                    // Add axis titles
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", height + margin.bottom - 10)
                        .attr("text-anchor", "middle")
                        .text("Position");

                    svg.append("text")
                        .attr("x", -margin.left+20)
                        .attr("y", height / 2)
                        .attr("text-anchor", "middle")
                        .attr("transform", "rotate(-90, " + (-margin.left+20) + ", " + height / 2 + ")")
                        .text("Average Salary ($)");

                    // Add chart title
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", -margin.top+20)
                        .attr("text-anchor", "middle")
                        .style("font-size", "22px")
                        .style("font-weight", "bold")
                        .text("NBA Players Average Salary by Position");

                    //  Add tooltips using d3-annotation
                    bars.append("title")
                        .text(function (d) { 
                            var scaledSalary = (d.average_salary / 1000000).toFixed(3);
                            return "Position: " + d.position + "\nRecord Count: " + d.record_count + "\nAverage Salary: $" + scaledSalary + "M"; 
                        });
                }

                // Build the second scene - Scatter plot
                function buildScatterPlot() {
                    // Define the dimensions and margins for the plot
                    var width = 600;
                    var height = 300;
                    var margin = { top: 40, right: 100, bottom: 50, left: 65};

                    // Create the SVG element
                    var svg = d3.select("#container").select("#visualization-container")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    // Define x and y scales
                    var x = d3.scaleLinear()
                        .domain([0, 48000000])
                        .range([0, width]);
                
                    var y = d3.scaleLinear()
                        .domain([65, 100])
                        .range([height, 0]);

                    var xAxis = d3.axisBottom(x)
                        .tickFormat(d3.format("~s")); // Custom format: e.g., "1M" instead of "1000000"

                    // Filter the scatter plot data based on the selected country and position (example code)
                    var filteredScatterPlotData = scatterPlotData.filter(function(d) {
                      return d.country === selectedCountry && d.position === selectedPosition;
                    });
                    
                    // Create circles for the scatter plot
                    var circles = svg.selectAll("circle")
                        .data(filteredScatterPlotData)
                        .enter()
                        .append("circle")
                        .attr("cx", function(d) { return x(d.salary); })
                        .attr("cy", function(d) { return y(d.rating); })
                        .attr("r", 4)
                        .attr("fill", "steelblue");

                    // Add axes
                    svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis);
                
                    svg.append("g")
                        .call(d3.axisLeft(y));

                    // Add axis titles
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", height + margin.bottom - 10)
                        .attr("text-anchor", "middle")
                        .text("Salary ($)");
                
                    svg.append("text")
                        .attr("x", -margin.left + 20)
                        .attr("y", height / 2)
                        .attr("text-anchor", "middle")
                        .attr("transform", "rotate(-90, " + (-margin.left + 20) + ", " + height / 2 + ")")
                        .text("Rating");

                    // Add chart title
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", -margin.top + 20)
                        .attr("text-anchor", "middle")
                        .style("font-size", "22px")
                        .style("font-weight", "bold")
                        .text("NBA Players Salary vs Rating");

                    // Add tooltips using d3-annotation
                    circles.append("title")
                        .text(function (d) { 
                            var scaledSalary = (d.salary / 1000000).toFixed(3);
                            return "Name: " + d.full_name + "\nRating: " + d.rating + "\nSalary: $" + scaledSalary + "M"; 
                        });

                    // Add line annotations for specific rating values
                    var lineAnnotations = [
                        {
                            type: d3.annotationXYThreshold,
                            note: {
                                label: '',
                                title: 'Superstars',
                                wrap: 100
                            },
                            x: 0, // x-coordinate start of the line (leftmost position)
                            y: y(100),
                            data: { x: 0, y: y(100) },
                            dx: width, // x-coordinate end of the line (rightmost position)
                            dy: 0 // Vertical alignment of the line
                        },
                        {
                            type: d3.annotationXYThreshold,
                            note: {
                                label: 'All-Stars',
                                title: '',
                                wrap: 100
                            },
                            x: 0,
                            y: y(92),
                            data: { x: 0, y: y(92) },
                            dx: width,
                            dy: 0
                        },
                        {
                            type: d3.annotationXYThreshold,
                            note: {
                                label: 'Starters',
                                title: '',
                                wrap: 100
                            },
                            x: 0,
                            y: y(86),
                            data: { x: 0, y: y(86) },
                            dx: width,
                            dy: 0
                        },
                        {
                            type: d3.annotationXYThreshold,
                            note: {
                                label: 'Role Players',
                                title: '',
                                wrap: 100
                            },
                            x: 0,
                            y: y(76),
                            data: { x: 0, y: y(76) },
                            dx: width,
                            dy: 0
                        }
                    ];
                    
                    // Create a line annotation group
                    var lineAnnotationGroup = svg.append('g')
                        .attr('class', 'line-annotation-group');
                    
                    // Add the line annotations to the group
                    var makeLineAnnotations = d3.annotation()
                        .type(d3.annotationXYThreshold)
                        .accessors({
                            x: function(d) { return d.x; },
                            y: function(d) { return d.y; }
                        })
                        .annotations(lineAnnotations);
                    
                    lineAnnotationGroup.call(makeLineAnnotations);
                    
                    // Style the line annotations
                    lineAnnotationGroup.selectAll('.annotation-line path')
                        .style('stroke-dasharray', '3,3') // Make the line dotted
                        .style('opacity', 0.6) // Reduce opacity
                        .style('stroke-width', 1.5); // Increase stroke width
                    
                    // Style the line annotation labels
                    lineAnnotationGroup.selectAll('.annotation-note-label')
                        .style('text-anchor', 'start') // Align labels to the right
                        .style('font-size', '16px'); // Adjust font size as needed
                }
                
                // Call the function to initially build the visualization
                updateVisualization();
                
            }).catch(function (error) {
                console.log(error);
            });
        }).catch(function (error) {
            console.log(error);
        });
    </script>
</body>
</html>
